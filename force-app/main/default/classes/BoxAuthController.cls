/**
 * Class : BoxAuthController
 * @auther Bhupendra
 * Last Modified By :
 * Last Modified Date :
 * Auth type: Authorization code (Web server flow)
 * Details: BoxAuthController to make callout and retrieve the JSON detail from Box.com
 * And parsing the JSON responses
 */

public class BoxAuthController {
    
    public string body{set;get;}
    
    public folderItemsList[] folderItems{set;get;}

    public PageReference authenticate(){
        //Add destination URL to this page reference and it's required params
        //End Point Name in Box.com << Authorize user >> 
        //Ex here we are using get method url with it's required params: https://developer.box.com/reference/get-authorize/#query-parameters
        //return new PageReference('https://account.box.com/api/oauth2/authorize?client_id=xfoi7i5jz01hfay1nac97sv5zdvmkrq2&response_type=code'); 
        return new PageReference('https://account.box.com/api/oauth2/authorize?client_id=50w2gupzckmti9h0iq280tanziswlrp2&response_type=code');
    }
    
    public void getAccessToken(){
        //Whenever we want to strip Query String parms from the url in Apex then we can use below notation
        //apexpages.currentPage().getParameters().get('code');
        String authCode = apexpages.currentPage().getParameters().get('code'); //this will strip the url and fetch only Auth code
        system.debug('Auth Code :'+authCode);
        
        //Step1- instantiate http class
        Http http = new Http();
        
        //Step2- instantiate httpRequest class and frame the request
        HttpRequest request = new HttpRequest();
        request.setHeader('Accept','application/json');
        //End Point Name in Box.com << Request access token >>
        request.setEndpoint('https://api.box.com/oauth2/token');//We can store endpoint in Apexclass/NameCredential/Even Hardcode it
        request.setMethod('POST'); //if method is post then we "cannot append" endpoints rather we will use: setBody(keys)
        //we can store client id and client secret in Apexclass/CustomSetting/Even CustomLable(not recommended)
        //request.setBody('grant_type=authorization_code&code='+authCode+'&client_id=xfoi7i5jz01hfay1nac97sv5zdvmkrq2&client_secret=rSlOn69k1e7jvwtY2RwCDUcS5r2mzpvB');
        request.setBody('grant_type=authorization_code&code='+authCode+'&client_id=50w2gupzckmti9h0iq280tanziswlrp2&client_secret=E215q3YtUu5iLHZVLJLlDc9lkj088D0y');
        
        //Step3- recieve/handle the reponse
        HttpResponse response = http.send(request);
        
        //Handling exception while getting response
        /*try{
            HttpResponse response = http.send(request);
            body = response.getBody();
        } Catch(exception e){
            system.debug('--Exception--'+e.getMessage());
        }*/
        
        //body = response.getBody(); //this response will retrieve access_token
        
        fromJSON d = (fromJSON)JSON.deserialize(response.getBody(),fromJSON.class); 
        //here we don't have list of item so we don't have to use wrapper class
        //And we direclt get access token using >> d.access_token
        
        //getting list of item from folder in box.com
        body = getFolders(d.access_token);
        
        //Deserializing folder itmes from parseFolderContent inner class
        parseFolderContent p = (parseFolderContent)JSON.deserialize(body,parseFolderContent.class);
        
        folderItems = new folderItemsList[]{};
        
            for(integer i=0;i<p.entries.size();i++){
                folderItems.add(new folderItemsList(p.entries[i].id,p.entries[i].type, p.entries[i].name));
            }
        
    }
    
    public String getFolders(String access_token){
        
        Http http = new Http();
        
        HttpRequest req = new HttpRequest();
        req.setHeader('Accept','application/json');
        //req.setEndpoint('https://api.box.com/2.0/folders/:folder_id/items');//here we need to provide folderId which we can get from box.com
        //End Point Name in Box.com << List items in folder >>
        req.setEndpoint('https://api.box.com/2.0/folders/310461657104/items');
        req.setMethod('GET');
        //We can check from Postman that header prefix is "Bearer"
        //here after Bearer we have to add 1 space and then token
        req.setHeader('Authorization','Bearer '+access_token);
        
        HttpResponse res = http.send(req); //this response will retrieve list of folder items
        return res.getBody();
    }
    
 //
//Generated by AdminBooster
//

public class fromJSON{
	public String access_token;	//gBrTshXlJbva59GacTPWDKc0Wmi357Fg
	public Integer expires_in;	//4011
	public cls_restricted_to[] restricted_to;
	public String refresh_token;	//8zBSXLVVK1IdmpPzEFXAafCyFtLHh6JLbnS2Q2j6AoVQAVJLEdVtLtG5ELXflMNq
	public String token_type;	//bearer
	
}
    class cls_restricted_to {
	}
    

//
//Wrapper class for folder items
//
    public class folderItemsList{
        public String id_x{set;get;}
        public String type_x{set;get;} 
        public String name_x{set;get;}
        public folderItemsList(String id_x, String type_x, String name_x){
            this.id_x = id_x;
            this.type_x = type_x;
            this.name_x = name_x;
        }
    }
//
//Generated by AdminBooster
//

public class parseFolderContent{
	public Integer total_count;	//2
	public cls_entries[] entries;
	public Integer offset;	//0
	public Integer limit_x;	//100
	public cls_order[] order;
	
}
    
    class cls_entries {
		public String type;	//file
		public String id;	//1795814617549
		public cls_file_version file_version;
		public String sequence_id;	//0
		public String etag;	//0
		public String sha1;	//4e691428a1e6264ca46d0b03eaba2dfb89e4b0d4
		public String name;	//ApexTesting_Syntax.png
	}
	class cls_file_version {
		public String type;	//file_version
		public String id;	//1979149544749
		public String sha1;	//4e691428a1e6264ca46d0b03eaba2dfb89e4b0d4
	}
	class cls_order {
		public String by_x;	//type
		public String direction;	//ASC
	}
}